name: Deploy Model Endpoint

on:
  workflow_dispatch:
    inputs:
      model_name:
        description: "Enter registered model name"
        required: true
      model_version:
        description: "Enter model version to deploy"
        required: true
permissions:
  id-token: write
  contents: read


jobs:
  deploy-endpoint:
    runs-on: ubuntu-latest
    #env:
      #DATABRICKS_HOST: "https://adb-3960540793376249.9.azuredatabricks.net/"
      #DATABRICKS_TOKEN: "dapifffd4cf7e7f4dd37b2a317d48d41d132-3"

    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: "21d1bb81-6473-43e2-b0cb-3ef758f0f08e"
          tenant-id: "30bf9f37-d550-4878-9494-1041656caf27"
          subscription-id: "16ecc6d9-35a4-484d-9b1e-680d86b42731"


      - name: Get secrets from Key Vault
        id: azurekeyvault
        uses: azure/CLI@v1
        with:
          inlineScript: |
            echo "Fetching Databricks secrets from Key Vault..."
            DATABRICKS_TOKEN=$(az keyvault secret show --vault-name "at-keyv" --name "db-token" --query value -o tsv)
            echo "DATABRICKS_TOKEN=$DATABRICKS_TOKEN" >> $GITHUB_ENV
      
            DATABRICKS_HOST=$(az keyvault secret show --vault-name "at-keyv" --name "databricks-host" --query value -o tsv)
            echo "DATABRICKS_HOST=$DATABRICKS_HOST" >> $GITHUB_ENV


      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main
        env:
          DATABRICKS_HOST: "https://adb-1670050298591902.2.azuredatabricks.net/"
          DATABRICKS_TOKEN: "dapi8b2ddfc4f27157d6a50024a16cb8a898-3"


      - name: Create and Run Job
        id: runjob
        run: |

          # Create job using deploy JSON and capture ID
          JOB_ID=$(databricks jobs create --json @deploy_endpoint.json | jq -r '.job_id')

          # Run job and pass parameters for deployment
          RUN_ID=$(databricks jobs run-now \
            --json "{\"job_id\": $JOB_ID, \"notebook_params\": {\"model_name\": \"${{ github.event.inputs.model_name }}\", \"model_version\": \"${{ github.event.inputs.model_version }}\"}}" \
            | jq -r '.run_id')

          echo "RUN_ID=$RUN_ID" >> $GITHUB_OUTPUT


      - name: Show Endpoint URL in GitHub Logs
        run: |
      
          # Get task run ID for Deploy_Endpoint task
          TASK_RUN_ID=$(databricks jobs get-run ${{ steps.runjob.outputs.RUN_ID }} | jq -r '.tasks[] | select(.task_key=="Deploy_Endpoint") | .run_id')
      
          # Fetch only the task output
          OUTPUT=$(databricks jobs get-run-output $TASK_RUN_ID | jq -r '.notebook_output.result')
      
          echo "::notice title=ðŸ”— Serving Endpoint::$OUTPUT"


